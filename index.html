<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Billing Entry</title>
 <style>
:root {
  --bg:#f4f7fb;
  --card:#fff;
  --accent:#2b9bd7;
  --accent2:#60c0e8;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
  background: linear-gradient(180deg, #e6f7ff, #f4f7fb);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

.wrap {
  width: 100%;
  max-width: 980px;
  display: grid;
  grid-template-columns: 1fr 360px;
  gap: 24px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 8px 30px rgba(32,41,50,0.08);
  width: 100%;
}

h1 {
  margin-bottom: 8px;
  font-size: 20px;
  color: #123;
}

label {
  display: block;
  margin-top: 12px;
  font-size: 13px;
  color: #334;
}

input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d6e6f2;
  outline: none;
  font-size: 14px;
}

input:focus {
  box-shadow: 0 6px 18px rgba(43,155,215,0.12);
  border-color: var(--accent);
}

.btn {
  display: inline-block;
  margin-top: 16px;
  padding: 10px 14px;
  border-radius: 10px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  color: #fff;
  border: none;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  text-align: center;
}

.muted {
  color: #6b7a85;
  font-size: 13px;
}

.preview {
  background: #fbfdff;
  border-radius: 8px;
  padding: 14px;
  border: 1px solid #e6f7ff;
  width: 100%;
}

.row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.row > div {
  flex: 1 1 0;
  min-width: 100px;
}

.small {
  font-size: 13px;
  color: #445;
}

.success {
  color: green;
  margin-top: 10px;
  font-weight: 600;
}

.error {
  color: #b00020;
  margin-top: 10px;
  font-weight: 600;
}

/* ======= RESPONSIVE ======= */
@media (max-width: 980px) {
  .wrap {
    grid-template-columns: 1fr 1fr;
  }
}

@media (max-width: 800px) {
  .wrap {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 600px) {
  body {
    padding: 12px;
  }

  h1 {
    font-size: 18px;
  }

  input, .btn {
    font-size: 14px;
    padding: 8px;
  }

  .row {
    flex-direction: column;
  }

  .row > div {
    width: 100%;
  }
}

@media (max-width: 400px) {
  h1 {
    font-size: 16px;
  }

  input, .btn {
    font-size: 13px;
    padding: 6px;
  }

  .preview {
    font-size: 12px;
    padding: 10px;
  }
}
</style>

</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>New Bill ‚Äî Enter Details</h1>

      <label>Customer Name</label>
      <input id="customerName" oninput="updatePreview()" placeholder="e.g. Ramesh Kumar">

      <label>Mobile</label>
      <input id="mobile" oninput="updatePreview()" placeholder="10-digit mobile">

      <label>Item / Service</label>
      <input id="item" oninput="updatePreview()" placeholder="e.g. Haircut">

      <div class="row">
        <div style="flex:1">
          <label>Qty</label>
          <input id="qty" type="number" min="0" value="1" oninput="updatePreview()">
        </div>
        <div style="width:140px">
          <label>Price</label>
          <input id="price" type="number" min="0" value="0" oninput="updatePreview()">
        </div>
      </div>

      <button class="btn" id="saveBtn" onclick="submitData()">Save to Sheet</button>
      <!-- Print / Download Buttons -->
<div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
  <button class="btn" id="printBtn" onclick="printInvoice()" style="flex:1; background:#28a745;">üñ® Print Last Invoice</button>
  <button class="btn" id="downloadBtn" onclick="downloadInvoice()" style="flex:1; background:#ff9800;">üíæ Download Last Invoice</button>
</div>
      <button id="downloadReportBtn">üìä Download Monthly Report</button>


      <div id="msgArea"></div>
      <p class="muted">Records are saved to your Google Sheet. You can print the sheet or build reports later.</p>
    </div>

    <!-- Preview panel -->
    <div class="card">
      <h1>üìù Data Entry Note (Live Preview)</h1>
      <div class="preview">
        <p><strong>Customer:</strong> <span id="pvName" class="small"></span></p>
        <p><strong>Mobile:</strong> <span id="pvMobile" class="small"></span></p>
        <p><strong>Item:</strong> <span id="pvItem" class="small"></span></p>
        <p><strong>Qty:</strong> <span id="pvQty" class="small"></span></p>
        <p><strong>Price:</strong> ‚Çπ <span id="pvPrice" class="small"></span></p>
        <hr>
        <p><strong>Total:</strong> ‚Çπ <span id="pvTotal" style="font-size:18px;font-weight:700"></span></p>
      </div>

      <div style="margin-top:14px" class="muted">
        <strong>Quick test (no save):</strong> change fields and see preview above.
      </div>
    </div>
  </div>

<script>
//   // ========== CONFIG - replace these ==========
//   const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzbluN5AvAAHwtEaAuflFeTO7ldUaELJnr3sDKLZDEFS53w0W5rbPWJvFt8GlcWuyE9XA/exec';   // put your Apps Script /exec URL
//   const SECRET = 'e404';            // must match WRITE_SECRET in Code.gs
//   // =============================================

//   function __(id){return document.getElementById(id)}

//   function updatePreview(){
//     const name = __('customerName').value;
//     const mobile = __('mobile').value;
//     const item = __('item').value;
//     const qty = Number(__('qty').value) || 0;
//     const price = Number(__('price').value) || 0;
//     __('pvName').innerText = name;
//     __('pvMobile').innerText = mobile;
//     __('pvItem').innerText = item;
//     __('pvQty').innerText = qty;
//     __('pvPrice').innerText = price;
//     __('pvTotal').innerText = (qty*price).toFixed(2);
//   }
//   updatePreview();

//   async function submitData(){
//     // small validation
//     const name = __('customerName').value.trim();
//     const mobile = __('mobile').value.trim();
//     const item = __('item').value.trim();
//     const qty = Number(__('qty').value) || 0;
//     const price = Number(__('price').value) || 0;
//     const msgArea = __('msgArea');
//     msgArea.innerHTML = '';

//     if (!item || qty<=0 || price<=0){
//       msgArea.innerHTML = '<div class="error">Please enter item, quantity and price (qty & price > 0).</div>';
//       return;
//     }

//     __('saveBtn').disabled = true;
//     __('saveBtn').innerText = 'Saving...';

//     // Use form-encoded body to avoid preflight (simple request)
//     const params = new URLSearchParams();
//     params.append('customerName', name);
//     params.append('mobile', mobile);
//     params.append('item', item);
//     params.append('qty', qty);
//     params.append('price', price);
//     params.append('secret', SECRET);

//     try {
//       const resp = await fetch(WEB_APP_URL, {
//         method: 'POST',
//         headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
//         body: params.toString()
//       });
//       const text = await resp.text();
//       let j;
//       try { j = JSON.parse(text); } catch(e){ j = { status:'error', message: text }; }
//       if (j.status && j.status === 'success') {
//         msgArea.innerHTML = '<div class="success">Saved ‚úì Invoice: ' + (j.invoice || '') + '</div>';
//         // clear inputs
//         __('customerName').value = '';
//         __('mobile').value = '';
//         __('item').value = '';
//         __('qty').value = 1;
//         __('price').value = 0;
//         updatePreview();
//       } else {
//         msgArea.innerHTML = '<div class="error">Error: ' + (j.message || 'Unknown') + '</div>';
//       }
//     } catch (err) {
//       msgArea.innerHTML = '<div class="error">Network/Server error: ' + err.message + '</div>';
//     } finally {
//       __('saveBtn').disabled = false;
//       __('saveBtn').innerText = 'Save to Sheet';
//     }
//   }


  
//   // Store last saved invoice data
// let lastInvoiceData = null;

// async function submitData(){
//   // ... existing code remains unchanged ...
//   if (j.status && j.status === 'success') {
//     lastInvoiceData = { 
//       customerName: name,
//       mobile: mobile,
//       item: item,
//       qty: qty,
//       price: price,
//       total: (qty*price).toFixed(2),
//       invoice: j.invoice || ''
//     };
//     msgArea.innerHTML = '<div class="success">Saved ‚úì Invoice: ' + (j.invoice || '') + '</div>';
//     // clear inputs
//     __('customerName').value = '';
//     __('mobile').value = '';
//     __('item').value = '';
//     __('qty').value = 1;
//     __('price').value = 0;
//     updatePreview();
//   }
//   // ... rest unchanged ...
// }

// // Print invoice in billing format
// function printInvoice(){
//   if(!lastInvoiceData){
//     alert("No invoice to print. Save first!");
//     return;
//   }
//   const printWindow = window.open('', '', 'width=800,height=600');
//   printWindow.document.write(`
//     <html>
//     <head>
//       <title>Invoice ${lastInvoiceData.invoice || ''}</title>
//       <style>
//         body{font-family:Arial,sans-serif;padding:20px;}
//         h2{text-align:center;}
//         table{width:100%;border-collapse:collapse;margin-top:20px;}
//         td, th{border:1px solid #000;padding:8px;text-align:left;}
//         th{background:#f2f2f2;}
//         .total{text-align:right;font-weight:bold;}
//       </style>
//     </head>
//     <body>
//       <h2>Invoice ${lastInvoiceData.invoice || ''}</h2>
//       <p><strong>Customer:</strong> ${lastInvoiceData.customerName}</p>
//       <p><strong>Mobile:</strong> ${lastInvoiceData.mobile}</p>
//       <table>
//         <tr><th>Item / Service</th><th>Qty</th><th>Price</th><th>Total</th></tr>
//         <tr>
//           <td>${lastInvoiceData.item}</td>
//           <td>${lastInvoiceData.qty}</td>
//           <td>‚Çπ ${lastInvoiceData.price}</td>
//           <td>‚Çπ ${lastInvoiceData.total}</td>
//         </tr>
//         <tr>
//           <td colspan="3" class="total">Grand Total</td>
//           <td>‚Çπ ${lastInvoiceData.total}</td>
//         </tr>
//       </table>
//     </body>
//     </html>
//   `);
//   printWindow.document.close();
//   printWindow.print();
// }

// // Download invoice as PDF using browser print
// function downloadInvoice(){
//   printInvoice(); // Browsers allow "Save as PDF" in print dialog
// }


// ========== CONFIG - replace these ==========
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby_uH7hEbkshQCNG1je2A-rZb_F_xcnM1qEld2HaWWjD29eQmdc-nEfP6fnMymgEZp4/exec'; // put your Apps Script /exec URL
const SECRET = 'e404'; // must match WRITE_SECRET in Code.gs
// =============================================

function __(id){return document.getElementById(id)}

// ================= PREVIEW UPDATE =================
function updatePreview(){
  const name = __('customerName').value;
  const mobile = __('mobile').value;
  const item = __('item').value;
  const qty = Number(__('qty').value) || 0;
  const price = Number(__('price').value) || 0;
  __('pvName').innerText = name;
  __('pvMobile').innerText = mobile;
  __('pvItem').innerText = item;
  __('pvQty').innerText = qty;
  __('pvPrice').innerText = price;
  __('pvTotal').innerText = (qty*price).toFixed(2);
}
updatePreview();

// ================= GLOBAL STORAGE =================
let lastInvoiceData = null;

// ================= SAVE TO SHEET =================
async function submitData(){
  const name = __('customerName').value.trim();
  const mobile = __('mobile').value.trim();
  const item = __('item').value.trim();
  const qty = Number(__('qty').value) || 0;
  const price = Number(__('price').value) || 0;
  const msgArea = __('msgArea');
  msgArea.innerHTML = '';

  // Validation
  if (!item || qty<=0 || price<=0){
    msgArea.innerHTML = '<div class="error">Please enter item, quantity and price (qty & price > 0).</div>';
    return;
  }

  __('saveBtn').disabled = true;
  __('saveBtn').innerText = 'Saving...';

  const params = new URLSearchParams();
  params.append('customerName', name);
  params.append('mobile', mobile);
  params.append('item', item);
  params.append('qty', qty);
  params.append('price', price);
  params.append('secret', SECRET);

  try {
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params.toString()
    });
    const text = await resp.text();
    let j;
    try { j = JSON.parse(text); } catch(e){ j = { status:'error', message: text }; }

    if (j.status && j.status === 'success') {
      // ‚úÖ store last invoice
      lastInvoiceData = { 
        customerName: name,
        mobile: mobile,
        item: item,
        qty: qty,
        price: price,
        total: (qty*price).toFixed(2),
        invoice: j.invoice || ''
      };

      msgArea.innerHTML = '<div class="success">Saved ‚úì Invoice: ' + (j.invoice || '') + '</div>';

      // clear inputs
      __('customerName').value = '';
      __('mobile').value = '';
      __('item').value = '';
      __('qty').value = 1;
      __('price').value = 0;
      updatePreview();
    } else {
      msgArea.innerHTML = '<div class="error">Error: ' + (j.message || 'Unknown') + '</div>';
    }
  } catch (err) {
    msgArea.innerHTML = '<div class="error">Network/Server error: ' + err.message + '</div>';
  } finally {
    __('saveBtn').disabled = false;
    __('saveBtn').innerText = 'Save to Sheet';
  }
}

// ================= PRINT INVOICE =================
function printInvoice(){
  if(!lastInvoiceData){
    alert("No invoice to print. Save first!");
    return;
  }
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write(`
    <html>
    <head>
      <title>Invoice ${lastInvoiceData.invoice || ''}</title>
      <style>
        body{font-family:Arial,sans-serif;padding:20px;}
        h2{text-align:center;}
        table{width:100%;border-collapse:collapse;margin-top:20px;}
        td, th{border:1px solid #000;padding:8px;text-align:left;}
        th{background:#f2f2f2;}
        .total{text-align:right;font-weight:bold;}
      </style>
    </head>
    <body>
      <h2>Invoice ${lastInvoiceData.invoice || ''}</h2>
      <p><strong>Customer:</strong> ${lastInvoiceData.customerName}</p>
      <p><strong>Mobile:</strong> ${lastInvoiceData.mobile}</p>
      <table>
        <tr><th>Item / Service</th><th>Qty</th><th>Price</th><th>Total</th></tr>
        <tr>
          <td>${lastInvoiceData.item}</td>
          <td>${lastInvoiceData.qty}</td>
          <td>‚Çπ ${lastInvoiceData.price}</td>
          <td>‚Çπ ${lastInvoiceData.total}</td>
        </tr>
        <tr>
          <td colspan="3" class="total">Grand Total</td>
          <td>‚Çπ ${lastInvoiceData.total}</td>
        </tr>
      </table>
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// ================= DOWNLOAD INVOICE =================
function downloadInvoice(){
  // Just trigger print dialog, user can choose "Save as PDF"
  printInvoice();
}






  // Replace with your actual Web App URL
  const REPORT_API_URL = "https://script.google.com/macros/s/AKfycby_uH7hEbkshQCNG1je2A-rZb_F_xcnM1qEld2HaWWjD29eQmdc-nEfP6fnMymgEZp4/exec";

  document.getElementById("downloadReportBtn").addEventListener("click", async () => {
    try {
      // Ask user for month/year (you can make this automatic or use inputs)
      const month = prompt("Enter month number (1-12):");
      const year = prompt("Enter year (YYYY):");

      if (!month || !year) {
        alert("Month and Year are required!");
        return;
      }

      // Call backend
      const res = await fetch(`${REPORT_API_URL}?month=${month}&year=${year}`);
      const data = await res.json();

      if (data.status === "ok") {
        // Open PDF link in new tab (download/print ready)
        window.open(data.url, "_blank");
      } else {
        alert("Error: " + data.message);
      }
    } catch (err) {
      console.error(err);
      alert("Something went wrong generating the report.");
    }
  });  


</script>
</body>
</html>
